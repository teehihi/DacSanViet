<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Chi Tiết Đơn Hàng - Đặc Sản Việt Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/admin-dashboard.css}">
</head>
<body>
    <!-- Sidebar -->
    <div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>
    
    <!-- Main Content -->
    <div class="admin-main">
        <!-- Header -->
        <div class="admin-header">
            <div class="header-title">
                <h1>Chi Tiết Đơn Hàng</h1>
                <p>Xem và quản lý thông tin đơn hàng</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='/admin/orders'">
                    <i class="bi bi-arrow-left"></i>
                    Quay Lại
                </button>
                <button class="btn btn-primary" th:onclick="'updateOrderStatus(' + ${order.id} + ')'">
                    <i class="bi bi-pencil"></i>
                    Cập Nhật Đơn Hàng
                </button>
            </div>
        </div>

        <!-- Order Info Cards -->
        <div class="order-detail-grid">
            <!-- Left Column -->
            <div class="order-detail-left">
                <!-- Order Status Card -->
                <div class="card">
                    <div class="card-header">
                        <h5>Thông Tin Đơn Hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="info-item-grid">
                            <div class="info-item">
                                <div class="info-label">Mã Đơn Hàng</div>
                                <div class="info-value" th:text="${order.orderNumber}">ORD123456</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Ngày Đặt</div>
                                <div class="info-value" th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">24/12/2024 15:30</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Trạng Thái Đơn Hàng</div>
                                <div class="info-value">
                                    <span th:class="'status-badge status-' + ${order.status == 'PENDING' ? 'pending' : 
                                                                                order.status == 'CONFIRMED' ? 'processing' :
                                                                                order.status == 'PROCESSING' ? 'processing' :
                                                                                order.status == 'SHIPPED' ? 'delivered' :
                                                                                order.status == 'DELIVERED' ? 'active' :
                                                                                order.status == 'CANCELLED' ? 'cancelled' : 'pending'}"
                                          th:text="${order.status == 'PENDING' ? 'Chờ Xác Nhận' :
                                                   order.status == 'CONFIRMED' ? 'Đã Xác Nhận' :
                                                   order.status == 'PROCESSING' ? 'Đang Xử Lý' :
                                                   order.status == 'SHIPPED' ? 'Đang Giao' :
                                                   order.status == 'DELIVERED' ? 'Đã Giao' :
                                                   order.status == 'CANCELLED' ? 'Đã Hủy' : order.status}">
                                        Chờ Xử Lý
                                    </span>
                                </div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Trạng Thái Thanh Toán</div>
                                <div class="info-value">
                                    <span th:class="'status-badge status-' + ${order.paymentStatus == 'PENDING' ? 'pending' :
                                                                                order.paymentStatus == 'COMPLETED' ? 'active' :
                                                                                order.paymentStatus == 'FAILED' ? 'cancelled' : 'pending'}"
                                          th:text="${order.paymentStatus == 'PENDING' ? 'Chờ Thanh Toán' :
                                                   order.paymentStatus == 'COMPLETED' ? 'Đã Thanh Toán' :
                                                   order.paymentStatus == 'FAILED' ? 'Thanh Toán Thất Bại' : order.paymentStatus}">
                                        Chờ Thanh Toán
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customer Info Card -->
                <div class="card">
                    <div class="card-header">
                        <h5>Thông Tin Khách Hàng</h5>
                    </div>
                    <div class="card-body">
                        <div class="info-item mb-3">
                            <div class="info-label">Tên Khách Hàng</div>
                            <div class="info-value" th:text="${order.customerName}">Nguyễn Văn A</div>
                        </div>
                        <div class="info-item mb-3">
                            <div class="info-label">Email</div>
                            <div class="info-value" th:text="${order.customerEmail}">email@example.com</div>
                        </div>
                        <div class="info-item mb-3">
                            <div class="info-label">Số Điện Thoại</div>
                            <div class="info-value" th:text="${order.customerPhone}">0123456789</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Địa Chỉ Giao Hàng</div>
                            <div class="info-value" th:text="${order.shippingAddressText}">123 Đường ABC, Quận 1, TP.HCM</div>
                        </div>
                    </div>
                </div>

                <!-- Products Card -->
                <div class="card">
                    <div class="card-header">
                        <h5>Sản Phẩm</h5>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Sản Phẩm</th>
                                    <th style="text-align: center;">Số Lượng</th>
                                    <th style="text-align: right;">Đơn Giá</th>
                                    <th style="text-align: right;">Tổng</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="item : ${order.orderItems}">
                                    <td>
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <img th:src="${item.productImageUrl}" 
                                                 th:alt="${item.productName}"
                                                 style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"
                                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23ddd%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2210%22%3ENo Image%3C/text%3E%3C/svg%3E'">
                                            <span th:text="${item.productName}">Sản phẩm</span>
                                        </div>
                                    </td>
                                    <td style="text-align: center;" th:text="${item.quantity}">1</td>
                                    <td style="text-align: right;" th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} + '₫'">100.000₫</td>
                                    <td style="text-align: right; font-weight: 600;" th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + '₫'">100.000₫</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="order-detail-right">
                <!-- Shipping Info Card -->
                <div class="card">
                    <div class="card-header">
                        <h5>Vận Chuyển</h5>
                    </div>
                    <div class="card-body">
                        <div class="info-item mb-3">
                            <div class="info-label">Phương Thức Vận Chuyển</div>
                            <div class="info-value">
                                <span th:if="${order.shippingMethod == 'EXPRESS_5H'}">Giao Nhanh 5H</span>
                                <span th:if="${order.shippingMethod == 'STANDARD'}">Giao Tiêu Chuẩn</span>
                                <span th:if="${order.shippingMethod != 'EXPRESS_5H' && order.shippingMethod != 'STANDARD'}" th:text="${order.shippingMethod}">Chưa chọn</span>
                            </div>
                        </div>
                        <div class="info-item mb-3" th:if="${order.shippingCarrier}">
                            <div class="info-label">Đơn Vị Vận Chuyển</div>
                            <div class="info-value">
                                <span th:if="${order.shippingCarrier == 'GHN'}">Giao Hàng Nhanh</span>
                                <span th:if="${order.shippingCarrier == 'GHTK'}">Giao Hàng Tiết Kiệm</span>
                                <span th:if="${order.shippingCarrier == 'VIETTEL_POST'}">Viettel Post</span>
                                <span th:if="${order.shippingCarrier == 'VN_POST'}">Bưu Điện Việt Nam</span>
                                <span th:if="${order.shippingCarrier == 'JT'}">J&T Express</span>
                                <span th:if="${order.shippingCarrier == 'DacSanVietShip'}">DacSanVietShip</span>
                                <span th:if="${order.shippingCarrier != 'GHN' && order.shippingCarrier != 'GHTK' && order.shippingCarrier != 'VIETTEL_POST' && order.shippingCarrier != 'VN_POST' && order.shippingCarrier != 'JT' && order.shippingCarrier != 'DacSanVietShip'}" th:text="${order.shippingCarrier}">Khác</span>
                            </div>
                        </div>
                        <div class="info-item mb-3" th:if="${order.trackingNumber}">
                            <div class="info-label">Mã Vận Đơn</div>
                            <div class="info-value" th:text="${order.trackingNumber}">TRACK123456</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Phí Vận Chuyển</div>
                            <div class="info-value" th:text="${#numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT')} + '₫'">30.000₫</div>
                        </div>
                    </div>
                </div>

                <!-- Payment Info Card -->
                <div class="card">
                    <div class="card-header">
                        <h5>Thanh Toán</h5>
                    </div>
                    <div class="card-body">
                        <div class="info-item mb-3">
                            <div class="info-label">Phương Thức Thanh Toán</div>
                            <div class="info-value">
                                <span th:if="${order.paymentMethod == 'COD'}">Thanh toán khi nhận hàng</span>
                                <span th:if="${order.paymentMethod == 'BANK_TRANSFER'}">Chuyển khoản ngân hàng</span>
                                <span th:if="${order.paymentMethod == 'MOMO'}">Ví MoMo</span>
                                <span th:if="${order.paymentMethod == 'VNPAY'}">VNPay</span>
                                <span th:if="${order.paymentMethod != 'COD' && order.paymentMethod != 'BANK_TRANSFER' && order.paymentMethod != 'MOMO' && order.paymentMethod != 'VNPAY'}" th:text="${order.paymentMethod}">Chưa chọn</span>
                            </div>
                        </div>
                        <div class="info-item mb-3">
                            <div class="info-label">Tạm Tính</div>
                            <div class="info-value" th:text="${#numbers.formatDecimal(order.totalAmount - order.shippingFee, 0, 'COMMA', 0, 'POINT')} + '₫'">500.000₫</div>
                        </div>
                        <div class="info-item mb-3">
                            <div class="info-label">Phí Vận Chuyển</div>
                            <div class="info-value" th:text="${#numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT')} + '₫'">30.000₫</div>
                        </div>
                        <div class="info-item" style="padding-top: 1rem; border-top: 2px solid var(--border-color);">
                            <div class="info-label" style="font-size: 1.1rem; font-weight: 700;">Tổng Cộng</div>
                            <div class="info-value" style="font-size: 1.5rem; color: var(--primary-color); font-weight: 700;" 
                                 th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + '₫'">530.000₫</div>
                        </div>
                    </div>
                </div>

                <!-- Notes Card -->
                <div class="card" th:if="${order.notes}">
                    <div class="card-header">
                        <h5>Ghi Chú</h5>
                    </div>
                    <div class="card-body">
                        <p th:text="${order.notes}" style="margin: 0; white-space: pre-wrap;">Ghi chú đơn hàng</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Order Modal (reuse from orders/index.html) -->
        <div id="editOrderModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <div id="editOrderContent"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Import functions from admin-orders.js
        const orderId = /*[[${order.id}]]*/ 0;
        /*]]>*/
    </script>
    <script th:src="@{/js/admin-orders.js}"></script>
</body>
</html>
