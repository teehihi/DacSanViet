<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng Nhập - Đặc Sản Việt</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css(v=2)}">

    <style>
        /* ... (Giữ nguyên phần CSS bên trên bài viết của bạn) ... */
        :root { --primary-color: #4ec2b6; --primary-dark: #2e857c; }
        body { font-family: 'Inter', sans-serif; background: #f8f9fa; }
        .auth-wrapper { min-height: calc(100vh - 70px); display: flex; align-items: center; padding: 40px 0; }
        .auth-container { background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 30px rgba(0,0,0,0.08); max-width: 1000px; margin: 0 auto; }
        .auth-left { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); padding: 60px 40px; color: white; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .auth-right { padding: 60px 50px; }
        .auth-right h3 { font-size: 2.2rem; font-weight: 800; color: var(--primary-color); margin-bottom: 0.5rem; }
        .form-control { padding: 0.75rem 1rem; border: 2px solid #e9ecef; border-radius: 8px; }
        .btn-primary { background: var(--primary-color); border: none; padding: 0.875rem 2rem; font-weight: 600; border-radius: 8px; width: 100%; }
        /* Tùy chỉnh hiệu ứng cho link Quên mật khẩu */
        .forgot-link { color: #6c757d; transition: color 0.3s; font-size: 0.9rem; }
        .forgot-link:hover { color: var(--primary-color) !important; text-decoration: underline !important; }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="auth-wrapper">
    <div class="container">
        <div class="auth-container">
            <div class="row g-0">
                <div class="col-lg-5 d-none d-lg-block">
                    <div class="auth-left">
                        <img src="https://files.catbox.moe/4ka4id.webp" alt="Đặc Sản Việt" class="auth-logo-img" style="width:350px; margin:0 auto 2rem;">
                        <h2>Chào mừng trở lại!</h2>
                        <p>Đăng nhập để trải nghiệm mua sắm đặc sản Việt Nam chất lượng cao.</p>
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="auth-right">
                        <h3>Đăng Nhập</h3>
                        <p class="subtitle">Nhập thông tin để tiếp tục</p>

                        <div id="forgotPasswordAlert" class="alert d-none alert-dismissible fade show" role="alert">
                            <span id="alertMessage"></span>
                            <button type="button" class="btn-close" onclick="this.parentElement.classList.add('d-none')"></button>
                        </div>

                        <form id="loginForm" th:action="@{/login}" method="post">
                            <div class="mb-3">
                                <label for="username" class="form-label">Email hoặc Tên đăng nhập</label>
                                <input type="text" class="form-control" id="username" name="username"
                                       placeholder="Nhập email hoặc tên đăng nhập" required>
                            </div>

                            <div class="mb-3">
                                <label for="password" class="form-label">Mật khẩu</label>
                                <div class="position-relative">
                                    <input type="password" class="form-control" id="password" name="password"
                                           placeholder="Nhập mật khẩu" required>
                                    <button type="button" class="btn btn-link position-absolute end-0 top-50 translate-middle-y"
                                            onclick="togglePassword('password', 'passwordIcon')"
                                            style="text-decoration: none; z-index: 10; color: #4ec2b6;">
                                        <i class="fas fa-eye" id="passwordIcon"></i>
                                    </button>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="remember" name="remember-me">
                                    <label class="form-check-label" for="remember">Ghi nhớ</label>
                                </div>
                                <a href="javascript:void(0)" onclick="handleForgotPassword()" class="forgot-link text-decoration-none">
                                    Quên mật khẩu?
                                </a>
                            </div>

                            <button type="submit" class="btn btn-primary">Đăng Nhập</button>
                        </form>

                        <div class="divider text-center my-4 position-relative">
                            <span class="bg-white px-3 position-relative" style="z-index:1; color:#6c757d;">Hoặc đăng nhập với</span>
                            <hr class="position-absolute w-100 top-50 m-0" style="z-index:0;">
                        </div>
                        <button class="btn btn-outline-secondary w-100 mb-2"><i class="fab fa-google me-2 text-danger"></i>Google</button>
                        <div class="auth-links text-center mt-4">
                            Chưa có tài khoản? <a th:href="@{/register}" style="color:var(--primary-color); font-weight:600;">Đăng ký ngay</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Xử lý ẩn/hiện mật khẩu
    function togglePassword(fieldId, iconId) {
        const field = document.getElementById(fieldId);
        const icon = document.getElementById(iconId);
        field.type = field.type === 'password' ? 'text' : 'password';
        icon.className = field.type === 'password' ? 'fas fa-eye' : 'fas fa-eye-slash';
    }

    // TÍNH NĂNG MỚI: Xử lý Quên mật khẩu
    async function handleForgotPassword() {
        const usernameInput = document.getElementById('username');
        const email = usernameInput.value.trim();
        const alertBox = document.getElementById('forgotPasswordAlert');
        const alertMsg = document.getElementById('alertMessage');

        // Kiểm tra người dùng đã nhập email/username chưa
        if (!email) {
            usernameInput.focus();
            showAlert('danger', 'Vui lòng nhập Email hoặc Tên đăng nhập vào ô trống bên trên trước!');
            return;
        }

        // Xác nhận hành động
        if (!confirm('Hệ thống sẽ đặt lại mật khẩu ngẫu nhiên và gửi về Email đã đăng ký của bạn. Bạn có đồng ý không?')) {
            return;
        }

        try {
            // Hiển thị trạng thái đang xử lý
            showAlert('info', 'Đang xử lý yêu cầu, vui lòng chờ trong giây lát...');

            // Gửi request đến API xử lý mật khẩu (Phải khớp với @PostMapping trong Controller)
            const response = await fetch('/api/forgot-password?email=' + encodeURIComponent(email), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', 'Thành công! Mật khẩu mới đã được gửi vào Email của bạn.');
            } else {
                showAlert('danger', 'Lỗi: ' + (data.message || 'Không tìm thấy tài khoản tương ứng.'));
            }
        } catch (error) {
            showAlert('danger', 'Có lỗi xảy ra trong quá trình kết nối server!');
        }
    }

    // Hàm hiển thị thông báo nhanh
    function showAlert(type, message) {
        const alertBox = document.getElementById('forgotPasswordAlert');
        const alertMsg = document.getElementById('alertMessage');

        alertBox.className = `alert alert-${type} alert-dismissible fade show`;
        alertMsg.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} me-2"></i> ${message}`;
        alertBox.classList.remove('d-none');

        // Tự động ẩn sau 10 giây nếu là thành công
        if (type === 'success') {
            setTimeout(() => alertBox.classList.add('d-none'), 10000);
        }
    }
</script>
</body>
</html>