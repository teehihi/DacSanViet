<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product != null ? product.name + ' - Đặc Sản Việt' : 'Chi Tiết Sản Phẩm'}">Chi Tiết Sản Phẩm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/header.css(v=1)}">
    <link rel="stylesheet" th:href="@{/css/modern-ecommerce.css(v=1)}">
    <link rel="stylesheet" th:href="@{/css/product-detail.css(v=4)}">
</head>
<body>
    <div th:replace="~{fragments/header :: header}"></div>
    <div th:replace="~{fragments/header :: mobile-menu}"></div>
    
    <!-- WebSocket Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    
    <div class="container-fluid px-3 px-md-5 py-5" th:if="${product != null}">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/}" class="text-teal"><i class="bi bi-house me-1"></i>Trang Chủ</a></li>
                <li class="breadcrumb-item"><a th:href="@{/products}" class="text-teal">Sản Phẩm</a></li>
                <li class="breadcrumb-item" th:if="${product.category != null}">
                    <a th:href="@{/products(categoryId=${product.categoryId})}" class="text-teal" th:text="${product.categoryName}">Category</a>
                </li>
                <li class="breadcrumb-item active" th:text="${product.name}">Product</li>
            </ol>
        </nav>
        
        <!-- Modern E-commerce Layout - 2 Column -->
        <div class="product-detail-wrapper">
            <div class="product-main-section">
                <!-- Left: Product Gallery -->
                <div class="product-gallery-wrapper">
                    <!-- Main Image -->
                    <div class="main-image-container" onclick="openImageModal()">
                        <span class="image-badge badge bg-success" th:if="${product.stockQuantity > 5}">
                            <i class="bi bi-star-fill me-1"></i>BEST SELLER
                        </span>
                        <span class="image-badge badge bg-danger" th:if="${product.stockQuantity <= 5 and product.stockQuantity > 0}">
                            <i class="bi bi-lightning-fill me-1"></i>Sắp hết
                        </span>
                        <img th:src="${productImages != null and !productImages.empty ? productImages[0].imageUrl : product.imageUrl}" 
                             class="main-image" 
                             th:alt="${product.name}" 
                             id="mainProductImage">
                    </div>
                    
                    <!-- Thumbnail Gallery - Horizontal Bottom -->
                    <div class="thumbnail-gallery-horizontal">
                        <img th:each="image : ${productImages}" 
                             th:src="${image.imageUrl}" 
                             class="thumbnail-horizontal" 
                             th:alt="${image.altText != null ? image.altText : product.name}"
                             th:classappend="${imageStat.index == 0 ? 'active' : ''}"
                             onclick="changeMainImage(this)">
                        <!-- Fallback if no images -->
                        <img th:if="${productImages == null or productImages.empty}" 
                             th:src="${product.imageUrl}" 
                             class="thumbnail-horizontal active" 
                             th:alt="${product.name}"
                             onclick="changeMainImage(this)">
                    </div>
                </div>
                
                <!-- Image Modal -->
                <div id="imageModal" class="image-modal" onclick="closeImageModal()">
                    <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
                    <span class="image-modal-nav image-modal-prev" onclick="event.stopPropagation(); prevImage()">&#10094;</span>
                    <img class="image-modal-content" id="modalImage" onclick="event.stopPropagation()">
                    <span class="image-modal-nav image-modal-next" onclick="event.stopPropagation(); nextImage()">&#10095;</span>
                </div>
                
                <!-- Right: Product Info -->
                <div class="product-info-section">
                    <h1 class="product-title" th:text="${product.name}">Product Name</h1>
                    
                    <div class="product-rating">
                        <div class="stars">
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-half"></i>
                        </div>
                        <span class="rating-count">(4.8/5 - 128 Reviews)</span>
                        <span class="stock-badge" th:if="${product.stockQuantity > 0}">Còn hàng</span>
                    </div>
                    
                    <div class="price-section">
                        <span class="current-price" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + '₫'">0₫</span>
                        <span class="original-price" th:if="${product.stockQuantity <= 10}">
                            <del th:text="${#numbers.formatDecimal(product.price * 1.2, 0, 'COMMA', 0, 'POINT')} + '₫'">0₫</del>
                        </span>
                        <span class="discount-badge" th:if="${product.stockQuantity <= 10}">-17%</span>
                    </div>
                    
                    <div class="product-short-description" th:if="${product.shortDescription != null and !product.shortDescription.isEmpty()}">
                        <p th:text="${product.shortDescription}">Mô tả ngắn về sản phẩm...</p>
                    </div>
                    
                    <div class="quantity-selector" th:if="${product.stockQuantity > 0}">
                        <label class="fw-semibold">Số lượng:</label>
                        <div class="quantity-input-group">
                            <button type="button" class="quantity-btn" id="decreaseQty">
                                <i class="bi bi-dash"></i>
                            </button>
                            <input type="number" class="quantity-input" id="quantity" value="1" min="1" th:max="${product.stockQuantity}">
                            <button type="button" class="quantity-btn" id="increaseQty">
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-buttons-modern" th:if="${product.stockQuantity > 0}">
                        <button class="btn-add-cart-modern" 
                                th:data-product-id="${product.id}"
                                th:data-product-name="${product.name}"
                                th:data-product-price="${product.price}"
                                th:data-product-image="${product.imageUrl}">
                            <i class="bi bi-cart-plus me-2"></i>Thêm Vào Giỏ
                        </button>
                        <button class="btn-wishlist-modern">
                            <i class="bi bi-heart"></i>
                        </button>
                    </div>
                    
                    <!-- Shipping Info -->
                    <div class="shipping-info-section">
                        <div class="shipping-header">
                            <img th:src="@{/images/ship-icon.webp}" alt="NowFree" class="shipping-logo" 
                                 onerror="this.src='https://via.placeholder.com/80x30?text=NowFree'">
                            <span class="shipping-title">Giao Nhanh Miễn Phí 5H</span>
                        </div>
                        <div class="shipping-description">
                            <p>Bạn muốn nhận hàng trước <span class="highlight-time">10h</span> ngày mai. Đặt hàng trước <span class="highlight-time">24h</span> và chọn giao nhanh <span class="highlight-time">5H</span> ở bước thanh toán. <a href="/shipping-policy" target="_blank" class="shipping-link">Xem thêm</a></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar - Services -->
            <div class="product-sidebar">
                <div class="sidebar-card">
                    <div class="sidebar-header">
                        <i class="bi bi-truck"></i>
                        <span>MIỄN PHÍ VẬN CHUYỂN</span>
                    </div>
                    <div class="sidebar-item">
                        <img th:src="@{/images/service-1.webp}" alt="Service" class="sidebar-icon"
                             onerror="this.src='https://via.placeholder.com/50'">
                        <div>
                            <strong>Giao Nhanh Miễn Phí 5H</strong>
                            <small>Tặng ngay 100K nếu giao trễ</small>
                        </div>
                    </div>
                    <div class="sidebar-item">
                        <img th:src="@{/images/service-2.webp}" alt="Service" class="sidebar-icon"
                             onerror="this.src='https://via.placeholder.com/50'">
                        <div>
                            <strong> Cam kết hàng chính hãng</strong>
                            <small>DacSanViet cam kết đền bù 100% nếu phát hiện hàng giả, kém chất lượng</small>
                        </div>
                    </div>
                    <div class="sidebar-item">
                        <img th:src="@{/images/service-3.webp}" alt="Service" class="sidebar-icon"
                             onerror="this.src='https://via.placeholder.com/50'">
                        <div>
                            <strong>Giao Hàng Miễn Phí</strong>
                            <small>(Áp dụng cho đơn từ 300k trên toàn quốc, nội thành Hồ Chí Minh miễn phí Ship cho đơn từ 90k) 
                                <a href="/shipping-policy" target="_blank" class="text-decoration-none">Xem chi tiết</a>
                            </small>
                        </div>
                    </div>
                    <div class="sidebar-item">
                        <img th:src="@{/images/service-4.webp}" alt="Service" class="sidebar-icon"
                             onerror="this.src='https://via.placeholder.com/50'">
                        <div>
                            <strong>Đổi trả</strong>
                            <small>trong 7 ngày đối với sản phẩm có lỗi từ nhà sản xuất</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Product Tabs -->
        <div class="product-tabs mt-5">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#story">
                        <i class="bi bi-book me-2"></i>Câu Chuyện
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#description">
                        <i class="bi bi-file-text me-2"></i>Mô Tả
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#specifications">
                        <i class="bi bi-list-ul me-2"></i>Thông Số
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="scrollToReviews(event)">
                        <i class="bi bi-star me-2"></i>Đánh Giá
                    </button>
                </li>
            </ul>
            
            <div class="tab-content">
                <div class="tab-pane fade show active" id="story">
                    <div class="product-story-section">
                        <div class="row align-items-center">
                            <div class="col-lg-6">
                                <!-- Story content from DB or fallback -->
                                <div th:if="${product.story != null and !product.story.isEmpty()}" 
                                     th:utext="${product.story}" 
                                     class="story-content">
                                </div>
                                <div th:if="${product.story == null or product.story.isEmpty()}">
                                    <h3 class="story-title">Gìn Giữ Hồn Quê, Lan Tỏa Giá Trị Việt</h3>
                                    <p class="story-text">
                                        Hành trình của chúng tôi bắt đầu từ những cánh đồng màu mỡ ở đồng bằng sông Cửu Long, 
                                        nơi mặt trời hôn lên từng trái cây mỗi buổi sáng. Chúng tôi làm việc trực tiếp với 
                                        những người nông dân địa phương để lựa chọn những sản phẩm đặc sản tốt nhất.
                                    </p>
                                    <p class="story-text">
                                        Bằng cách kết hợp phương pháp sấy khô truyền thống được truyền qua nhiều thế hệ với 
                                        các tiêu chuẩn vệ sinh hiện đại, chúng tôi đảm bảo rằng mỗi miếng bạn thưởng thức đều 
                                        là một kết nối với di sản Việt Nam. Khi bạn chọn Đặc Sản Việt, bạn đang hỗ trợ nông 
                                        nghiệp địa phương và giữ gìn truyền thống của chúng ta.
                                    </p>
                                    <div class="story-highlights mt-4">
                                        <div class="highlight-item">
                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            <span>Làm việc trực tiếp với nông dân địa phương</span>
                                        </div>
                                        <div class="highlight-item">
                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            <span>Phương pháp chế biến truyền thống kết hợp hiện đại</span>
                                        </div>
                                        <div class="highlight-item">
                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            <span>Đảm bảo an toàn vệ sinh thực phẩm 100%</span>
                                        </div>
                                        <div class="highlight-item">
                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                            <span>Hỗ trợ phát triển nông nghiệp bền vững</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="story-image-container">
                                    <img th:src="${product.storyImageUrl != null and !product.storyImageUrl.isEmpty() ? product.storyImageUrl : 'https://images.unsplash.com/photo-1605000797499-95a51c5269ae?w=800&q=80'}" 
                                         alt="Product Story" 
                                         class="story-image">
                                    <div class="story-badge">
                                        <i class="bi bi-heart-fill"></i>
                                        <span>Made with Love</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="description">
                    <div th:if="${product.description != null and !product.description.isEmpty()}" 
                         th:utext="${product.description}" 
                         class="product-description-content">
                    </div>
                    <p th:if="${product.description == null or product.description.isEmpty()}">
                        Chưa có mô tả chi tiết cho sản phẩm này.
                    </p>
                </div>
                
                <div class="tab-pane fade" id="specifications">
                    <table class="specs-table">
                        <tr><td>Danh mục</td><td th:text="${product.categoryName != null ? product.categoryName : 'Chưa phân loại'}">Category</td></tr>
                        <tr><td>Tình trạng</td><td><span class="badge bg-success" th:if="${product.stockQuantity > 0}">Còn hàng</span></td></tr>
                        <tr><td>Số lượng</td><td th:text="${product.stockQuantity}">0</td></tr>
                        <tr><td>Xuất xứ</td><td th:text="${product.origin != null ? product.origin : 'Việt Nam'}">Việt Nam</td></tr>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Reviews Section -->
        <div class="reviews-section mt-5" id="reviewsSection" th:if="${product != null}">
            <h3 class="section-title mb-4"><i class="bi bi-star me-2"></i>Đánh Giá Sản Phẩm</h3>
            
            <div class="review-layout">
                <!-- Left: Rating Summary -->
                <div class="review-summary-box">
                    <div class="review-score-display">
                        <div class="review-score-large">4.8</div>
                        <div class="stars-large mb-2">
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-fill"></i>
                            <i class="bi bi-star-half"></i>
                        </div>
                        <div class="review-count">Dựa trên 128 đánh giá</div>
                    </div>
                    
                    <div class="review-bars-compact">
                        <div class="review-bar-row">
                            <span class="bar-number">5</span>
                            <i class="bi bi-star-fill"></i>
                            <div class="bar-track">
                                <div class="bar-progress" style="width: 85%"></div>
                            </div>
                            <span class="bar-percentage">85%</span>
                        </div>
                        <div class="review-bar-row">
                            <span class="bar-number">4</span>
                            <i class="bi bi-star-fill"></i>
                            <div class="bar-track">
                                <div class="bar-progress" style="width: 10%"></div>
                            </div>
                            <span class="bar-percentage">10%</span>
                        </div>
                        <div class="review-bar-row">
                            <span class="bar-number">3</span>
                            <i class="bi bi-star-fill"></i>
                            <div class="bar-track">
                                <div class="bar-progress" style="width: 3%"></div>
                            </div>
                            <span class="bar-percentage">3%</span>
                        </div>
                        <div class="review-bar-row">
                            <span class="bar-number">2</span>
                            <i class="bi bi-star-fill"></i>
                            <div class="bar-track">
                                <div class="bar-progress" style="width: 1%"></div>
                            </div>
                            <span class="bar-percentage">1%</span>
                        </div>
                        <div class="review-bar-row">
                            <span class="bar-number">1</span>
                            <i class="bi bi-star-fill"></i>
                            <div class="bar-track">
                                <div class="bar-progress" style="width: 1%"></div>
                            </div>
                            <span class="bar-percentage">1%</span>
                        </div>
                    </div>
                    
                    <button class="btn-write-review">
                        <i class="bi bi-pencil-square me-2"></i>Viết đánh giá
                    </button>
                </div>
                
                <!-- Right: Reviews List -->
                <div class="review-content-box">
                    <div class="reviews-list-modern">
                        <div class="review-item-modern">
                            <div class="reviewer-header">
                                <div class="reviewer-avatar-circle">L</div>
                                <div class="reviewer-info">
                                    <div class="reviewer-name">Lan Nguyen</div>
                                    <div class="reviewer-badge">
                                        <i class="bi bi-patch-check-fill"></i> Verified Buyer
                                    </div>
                                </div>
                                <div class="review-time">2 ngày trước</div>
                            </div>
                            <div class="review-stars-row">
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                            </div>
                            <h6 class="review-title">Hương vị đích thực!</h6>
                            <p class="review-text">Ngon tuyệt! Hương vị giống hệt như những chiếc bánh tôi từng ăn hồi nhỏ ở quê nhà Tiền Giang. Giòn tan và không quá ngọt.</p>
                            <div class="review-photos">
                                <img src="https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=80&q=80" alt="Review photo">
                                <img src="https://images.unsplash.com/photo-1606787366850-de6330128bfc?w=80&q=80" alt="Review photo">
                            </div>
                        </div>
                        
                        <div class="review-item-modern">
                            <div class="reviewer-header">
                                <div class="reviewer-avatar-circle" style="background: #17a2b8;">M</div>
                                <div class="reviewer-info">
                                    <div class="reviewer-name">Minh Tran</div>
                                    <div class="reviewer-badge-simple">Reviewer</div>
                                </div>
                                <div class="review-time">1 tuần trước</div>
                            </div>
                            <div class="review-stars-row">
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                                <i class="bi bi-star-fill"></i>
                            </div>
                            <p class="review-text">Bao bì đẹp mắt, rất thích hợp để làm quà tặng. Chất lượng mít thì tuyệt hảo.</p>
                        </div>
                    </div>
                    
                    <button class="btn-load-more">
                        <i class="bi bi-chevron-down me-2"></i>Xem thêm
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Q&A Section (Real-time Discussion) -->
        <div class="qa-section mt-5" id="qaSection" th:if="${product != null}">
            <h3 class="section-title mb-4"><i class="bi bi-chat-dots me-2"></i>Hỏi Đáp Sản Phẩm</h3>
            
            <div class="qa-container">
                <!-- Question Form -->
                <div class="qa-form-card mb-4">
                    <div class="row g-3 mb-3" th:if="${#authorization.expression('!isAuthenticated()')}">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="userNameInput" placeholder="Tên của bạn *" required>
                        </div>
                        <div class="col-md-6">
                            <input type="email" class="form-control" id="userEmailInput" placeholder="Email của bạn *" required>
                        </div>
                    </div>
                    <div class="d-flex align-items-start gap-3">
                        <img th:if="${#authorization.expression('isAuthenticated()')}"
                             th:src="@{https://ui-avatars.com/api/?name={name}&background=4ec2b6&color=fff(name=${#authentication.principal.username})}" 
                             class="qa-avatar" alt="Avatar" id="userAvatar">
                        <img th:if="${#authorization.expression('!isAuthenticated()')}"
                             src="https://ui-avatars.com/api/?name=User&background=4ec2b6&color=fff" 
                             class="qa-avatar" alt="Avatar" id="userAvatar">
                        <div class="flex-grow-1">
                            <textarea class="form-control qa-input" 
                                      id="questionInput" 
                                      rows="3" 
                                      placeholder="Đặt câu hỏi về sản phẩm này..."></textarea>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Câu hỏi sẽ được hiển thị real-time cho mọi người
                                </small>
                                <button class="btn btn-primary btn-sm" onclick="sendQuestion()">
                                    <i class="bi bi-send me-1"></i>Gửi câu hỏi
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Questions List -->
                <div class="qa-list" id="qaList">
                    <!-- Questions will be loaded here -->
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-chat-square-text fs-1"></i>
                        <p class="mt-2">Chưa có câu hỏi nào. Hãy là người đầu tiên đặt câu hỏi!</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- FAQ Section -->
        <div class="faq-section mt-5" th:if="${product != null}">
            <h3 class="section-title mb-4"><i class="bi bi-question-circle me-2"></i>Câu Hỏi Thường Gặp</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Sản Phẩm Của Shop Có Đảm Bảo An Toàn Vệ Sinh Thực Phẩm Không?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            100% sản phẩm đều đảm bảo an toàn vệ sinh thực phẩm, có nguồn gốc xuất xứ rõ ràng và được kiểm tra kỹ lưỡng trước khi giao hàng.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Sản Phẩm Đặc Sản Của Shop Có Nguồn Gốc Từ Đâu?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Sản phẩm được lấy trực tiếp từ các vùng đặc sản nổi tiếng khắp Việt Nam, đảm bảo chất lượng và hương vị đặc trưng của từng vùng miền.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Làm Thế Nào Để Đặt Hàng?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Bạn có thể đặt hàng trực tiếp trên website, chọn sản phẩm và thêm vào giỏ hàng, sau đó điền thông tin giao hàng và thanh toán.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Thời Gian Giao Hàng Là Bao Lâu?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Thời gian giao hàng từ 2-5 ngày tùy theo khu vực. Nội thành Hà Nội và TP.HCM: 1-2 ngày. Các tỉnh thành khác: 3-5 ngày.
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Shop Có Giao Hàng Toàn Quốc Không?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Có, chúng tôi giao hàng toàn quốc. Phí vận chuyển sẽ được tính dựa trên khoảng cách và trọng lượng đơn hàng.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Tôi Có Được Kiểm Tra Hàng Trước Khi Nhận Không?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Có, bạn được quyền kiểm tra hàng trước khi thanh toán. Nếu không hài lòng, bạn có thể từ chối nhận hàng.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Shop Chấp Nhận Những Hình Thức Thanh Toán Nào?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Chúng tôi chấp nhận thanh toán COD (tiền mặt khi nhận hàng), chuyển khoản ngân hàng, và các ví điện tử như MoMo, ZaloPay, VNPay.
                        </div>
                    </div>
                    
                    <div class="faq-item">
                        <button class="faq-question" onclick="toggleFaq(this)">
                            <span>Chính Sách Đổi Trả Sản Phẩm Như Thế Nào?</span>
                            <i class="bi bi-chevron-down faq-icon"></i>
                        </button>
                        <div class="faq-answer">
                            Chúng tôi hỗ trợ đổi trả trong vòng 7 ngày nếu sản phẩm có lỗi từ nhà sản xuất hoặc không đúng mô tả. Sản phẩm phải còn nguyên vẹn.
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Related Products Section -->
        <div class="related-products mt-5" th:if="${product != null}">
            <h3 class="section-title mb-4"><i class="bi bi-grid me-2"></i>Có Thể Bạn Thích</h3>
            <div class="related-products-slider-wrapper">
                <div class="related-products-slider" id="relatedProductsSlider">
                    <!-- Sample products for testing if relatedProducts is empty -->
                    <div class="related-product-item" th:if="${relatedProducts == null or relatedProducts.empty}">
                        <div class="product-card h-100">
                            <div class="position-relative">
                                <img src="https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&q=80" 
                                     class="product-img w-100" alt="Sản phẩm mẫu">
                            </div>
                            <div class="p-3">
                                <h6 class="fw-bold mb-2">Sản phẩm mẫu 1</h6>
                                <p class="text-muted small mb-2">Mô tả sản phẩm mẫu</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-primary fw-bold">100,000₫</span>
                                    <button class="btn btn-sm btn-primary">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="related-product-item" th:each="relatedProduct : ${relatedProducts}">
                        <div class="product-card h-100">
                            <div class="position-relative">
                                <img th:src="${relatedProduct.imageUrl}" 
                                     class="product-img w-100" 
                                     th:alt="${relatedProduct.name}"
                                     onerror="this.src='https://images.unsplash.com/photo-1567620905732-2d1ec7ab7445?w=400&q=80'">
                                <span class="badge bg-success position-absolute top-0 end-0 m-2" th:if="${relatedProduct.isFeatured}">
                                    <i class="bi bi-star-fill me-1"></i>Nổi bật
                                </span>
                                <span class="badge bg-danger position-absolute top-0 end-0 m-2" th:if="${relatedProduct.stockQuantity <= 5 and relatedProduct.stockQuantity > 0}">
                                    <i class="bi bi-fire me-1"></i>Sắp hết
                                </span>
                            </div>
                            <div class="p-3">
                                <a th:href="@{/products/{id}(id=${relatedProduct.id})}" class="text-decoration-none text-dark">
                                    <h6 class="fw-bold mb-2" th:text="${relatedProduct.name}">Tên sản phẩm</h6>
                                </a>
                                <p class="text-muted small mb-2" style="height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;" 
                                   th:text="${relatedProduct.description}">Mô tả</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-primary fw-bold" th:text="${#numbers.formatDecimal(relatedProduct.price, 0, 'COMMA', 0, 'POINT')} + '₫'">0₫</span>
                                    <button class="btn btn-sm btn-primary add-to-cart-btn" 
                                            th:data-product-id="${relatedProduct.id}"
                                            th:data-product-name="${relatedProduct.name}"
                                            th:data-product-price="${relatedProduct.price}"
                                            th:data-product-image="${relatedProduct.imageUrl}"
                                            onclick="addToCartFromRelated(this)">
                                        <i class="bi bi-cart-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script>
        function toggleFaq(button) {
            const answer = button.nextElementSibling;
            const isActive = button.classList.contains('active');
            
            // Close all other FAQs in the same column
            const column = button.closest('.col-md-6');
            column.querySelectorAll('.faq-question').forEach(q => {
                q.classList.remove('active');
                q.nextElementSibling.classList.remove('show');
            });
            
            // Toggle current FAQ
            if (!isActive) {
                button.classList.add('active');
                answer.classList.add('show');
            }
        }
        
        function scrollToReviews(event) {
            event.preventDefault();
            const reviewsSection = document.getElementById('reviewsSection');
            if (reviewsSection) {
                reviewsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Image gallery functions
        function changeMainImage(thumbnail) {
            const mainImage = document.getElementById('mainProductImage');
            if (mainImage && thumbnail) {
                mainImage.src = thumbnail.src;
                
                // Update active state
                document.querySelectorAll('.thumbnail-horizontal').forEach(t => {
                    t.classList.remove('active');
                });
                thumbnail.classList.add('active');
            }
        }
        
        function openImageModal() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const mainImage = document.getElementById('mainProductImage');
            
            if (modal && modalImg && mainImage) {
                modal.classList.add('show');
                modalImg.src = mainImage.src;
                document.body.style.overflow = 'hidden';
            }
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }
        
        // WebSocket Q&A Implementation
        let stompClient = null;
        let productId = parseInt('[[${product.id}]]') || 0;
        let isAuthenticated = [[${#authorization.expression('isAuthenticated()')}]] || false;
        let currentUserName = '[[${#authorization.expression("isAuthenticated()") ? #authentication.name : ""}]]' || '';
        let currentUserEmail = '';
        
        // Get user email from authenticated user
        if (isAuthenticated) {
            // Try to get email from principal
            try {
                currentUserEmail = '[[${#authorization.expression("isAuthenticated()") ? #authentication.principal.email : ""}]]' || '';
            } catch(e) {
                console.log('Could not get user email, using username as fallback');
                currentUserEmail = currentUserName + '@example.com';
            }
        }
        
        console.log('User info:', {isAuthenticated, currentUserName, currentUserEmail, productId});
        
        // Load saved user info from localStorage
        function loadSavedUserInfo() {
            if (!isAuthenticated) {
                const savedName = localStorage.getItem('qaUserName');
                const savedEmail = localStorage.getItem('qaUserEmail');
                
                const nameInput = document.getElementById('userNameInput');
                const emailInput = document.getElementById('userEmailInput');
                
                if (savedName && nameInput) {
                    nameInput.value = savedName;
                    updateAvatar(savedName);
                }
                if (savedEmail && emailInput) {
                    emailInput.value = savedEmail;
                }
            }
        }
        
        // Save user info to localStorage
        function saveUserInfo(name, email) {
            if (!isAuthenticated) {
                localStorage.setItem('qaUserName', name);
                localStorage.setItem('qaUserEmail', email);
            }
        }
        
        // Update avatar
        function updateAvatar(name) {
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(name || 'User')}&background=4ec2b6&color=fff`;
            const avatar = document.getElementById('userAvatar');
            if (avatar) {
                avatar.src = avatarUrl;
            }
        }
        
        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            
            stompClient.connect({}, function(frame) {
                console.log('Connected to WebSocket:', frame);
                
                // Subscribe to product Q&A topic
                stompClient.subscribe('/topic/product/' + productId + '/qa', function(message) {
                    const qaMessage = JSON.parse(message.body);
                    console.log('Received WebSocket message:', qaMessage);
                    
                    // Check if it's a reply or a new question
                    if (qaMessage.isReply && qaMessage.parentId) {
                        console.log('This is a reply, calling displayReply');
                        displayReply(qaMessage, qaMessage.parentId);
                    } else {
                        console.log('This is a new question, calling displayQuestion');
                        displayQuestion(qaMessage);
                    }
                });
                
                // Subscribe to like updates
                stompClient.subscribe('/topic/product/' + productId + '/qa/like', function(message) {
                    const likeUpdate = JSON.parse(message.body);
                    updateLikeCount(likeUpdate.id, likeUpdate.likesCount);
                });
                
                // Load existing Q&A
                loadExistingQA();
            }, function(error) {
                console.error('WebSocket connection error:', error);
                showNotification('Không thể kết nối đến hệ thống Q&A. Vui lòng thử lại sau.', 'error');
            });
        }
        
        function loadExistingQA() {
            console.log('Loading Q&A for product:', productId);
            fetch('/api/products/' + productId + '/qa')
                .then(response => response.json())
                .then(qaList => {
                    console.log('Loaded Q&A:', qaList);
                    const qaListElement = document.getElementById('qaList');
                    qaListElement.innerHTML = '';
                    
                    if (qaList.length === 0) {
                        qaListElement.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-chat-square-text fs-1"></i>
                                <p class="mt-2">Chưa có câu hỏi nào. Hãy là người đầu tiên đặt câu hỏi!</p>
                            </div>
                        `;
                    } else {
                        qaList.forEach(qa => {
                            // Only display Q&A for current product
                            if (qa.productId === productId) {
                                displayQuestion(qa);
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading Q&A:', error);
                });
        }
        
        function sendQuestion() {
            console.log('sendQuestion called');
            console.log('isAuthenticated:', isAuthenticated);
            console.log('currentUserName:', currentUserName);
            console.log('currentUserEmail:', currentUserEmail);
            
            const input = document.getElementById('questionInput');
            let userName, userEmail;
            
            if (isAuthenticated) {
                userName = currentUserName;
                userEmail = currentUserEmail;
                console.log('Using authenticated user:', userName, userEmail);
            } else {
                const nameInput = document.getElementById('userNameInput');
                const emailInput = document.getElementById('userEmailInput');
                
                console.log('nameInput:', nameInput);
                console.log('emailInput:', emailInput);
                
                if (!nameInput || !emailInput || !nameInput.value.trim() || !emailInput.value.trim()) {
                    showNotification('Vui lòng điền đầy đủ thông tin', 'warning');
                    return;
                }
                
                userName = nameInput.value.trim();
                userEmail = emailInput.value.trim();
                
                console.log('Using guest user:', userName, userEmail);
                
                // Save to localStorage
                saveUserInfo(userName, userEmail);
            }
            
            if (!input || !input.value.trim()) {
                showNotification('Vui lòng nhập câu hỏi', 'warning');
                return;
            }
            
            if (!stompClient || !stompClient.connected) {
                showNotification('Đang kết nối lại...', 'info');
                connectWebSocket();
                setTimeout(() => sendQuestion(), 1000);
                return;
            }
            
            const message = {
                productId: productId,
                userName: userName,
                userEmail: userEmail,
                question: input.value.trim(),
                isReply: false,
                parentId: null
            };
            
            console.log('Sending message:', message);
            stompClient.send('/app/product/qa', {}, JSON.stringify(message));
            
            input.value = '';
            showNotification('Câu hỏi đã được gửi!', 'success');
        }
        
        function displayQuestion(qa) {
            // Only display if it's for the current product
            if (qa.productId !== productId) {
                console.log('Skipping Q&A for different product:', qa.productId, 'current:', productId);
                return;
            }
            
            const qaListElement = document.getElementById('qaList');
            
            // Remove empty state if exists
            const emptyState = qaListElement.querySelector('.text-center.text-muted');
            if (emptyState) {
                emptyState.remove();
            }
            
            const qaItem = document.createElement('div');
            qaItem.className = 'qa-item';
            qaItem.setAttribute('data-qa-id', qa.id);
            
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(qa.userName)}&background=4ec2b6&color=fff`;
            const timeAgo = qa.timestamp ? formatTimeAgo(qa.timestamp) : 'Vừa xong';
            
            qaItem.innerHTML = `
                <div class="qa-item-header">
                    <img src="${avatarUrl}" class="qa-avatar" alt="${qa.userName}">
                    <div class="qa-item-content">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="qa-item-author">${qa.userName}</span>
                                <span class="qa-item-time">${timeAgo}</span>
                            </div>
                            <div class="qa-actions">
                                <button class="qa-action-btn like-btn" onclick="toggleLike(${qa.id})">
                                    <i class="bi bi-hand-thumbs-up"></i>
                                    <span class="like-count">${qa.likesCount || 0}</span>
                                </button>
                                <button class="qa-action-btn reply-btn" onclick="toggleReplyForm(${qa.id})">
                                    <i class="bi bi-reply"></i>
                                    Trả lời
                                </button>
                            </div>
                        </div>
                        <p class="qa-item-question">${qa.question}</p>
                        ${qa.answer ? `
                            <div class="qa-item-answer">
                                <div class="qa-item-answer-header">
                                    <span class="qa-shop-badge">SHOP</span>
                                    <span class="qa-item-time">${qa.answerTimestamp ? formatTimeAgo(qa.answerTimestamp) : ''}</span>
                                </div>
                                <p class="qa-item-answer-text">${qa.answer}</p>
                            </div>
                        ` : ''}
                        <div class="qa-reply-form" id="replyForm${qa.id}" style="display: none;">
                            <div class="d-flex align-items-start gap-2 mt-3">
                                <img src="https://ui-avatars.com/api/?name=User&background=4ec2b6&color=fff" 
                                     class="qa-avatar-small" alt="Avatar">
                                <div class="flex-grow-1">
                                    ${!isAuthenticated ? `
                                        <input type="text" class="form-control form-control-sm mb-2" 
                                               id="replyName${qa.id}" placeholder="Tên của bạn *">
                                        <input type="email" class="form-control form-control-sm mb-2" 
                                               id="replyEmail${qa.id}" placeholder="Email của bạn *">
                                    ` : ''}
                                    <textarea class="form-control form-control-sm mb-2" 
                                              id="replyText${qa.id}" 
                                              rows="2" 
                                              placeholder="Nhập câu trả lời..."></textarea>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary btn-sm" onclick="sendReply(${qa.id})">
                                            <i class="bi bi-send me-1"></i>Gửi
                                        </button>
                                        <button class="btn btn-secondary btn-sm" onclick="toggleReplyForm(${qa.id})">
                                            Hủy
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="qa-replies-container" id="replies${qa.id}"></div>
                    </div>
                </div>
            `;
            
            qaListElement.insertBefore(qaItem, qaListElement.firstChild);
            
            // Load replies if any
            if (qa.id) {
                loadReplies(qa.id);
            }
        }
        
        function toggleReplyForm(qaId) {
            const replyForm = document.getElementById('replyForm' + qaId);
            if (replyForm) {
                const isHidden = replyForm.style.display === 'none';
                replyForm.style.display = isHidden ? 'block' : 'none';
                
                // Load saved user info if not authenticated
                if (isHidden && !isAuthenticated) {
                    const savedName = localStorage.getItem('qaUserName');
                    const savedEmail = localStorage.getItem('qaUserEmail');
                    
                    const nameInput = document.getElementById('replyName' + qaId);
                    const emailInput = document.getElementById('replyEmail' + qaId);
                    
                    if (savedName && nameInput) nameInput.value = savedName;
                    if (savedEmail && emailInput) emailInput.value = savedEmail;
                }
            }
        }
        
        function sendReply(parentId) {
            let userName, userEmail;
            
            if (isAuthenticated) {
                userName = currentUserName;
                userEmail = currentUserEmail;
            } else {
                const nameInput = document.getElementById('replyName' + parentId);
                const emailInput = document.getElementById('replyEmail' + parentId);
                
                if (!nameInput || !emailInput || !nameInput.value.trim() || !emailInput.value.trim()) {
                    showNotification('Vui lòng điền đầy đủ thông tin', 'warning');
                    return;
                }
                
                userName = nameInput.value.trim();
                userEmail = emailInput.value.trim();
                
                // Save to localStorage
                saveUserInfo(userName, userEmail);
            }
            
            const textInput = document.getElementById('replyText' + parentId);
            
            if (!textInput || !textInput.value.trim()) {
                showNotification('Vui lòng nhập câu trả lời', 'warning');
                return;
            }
            
            if (!stompClient || !stompClient.connected) {
                showNotification('Đang kết nối lại...', 'info');
                connectWebSocket();
                setTimeout(() => sendReply(parentId), 1000);
                return;
            }
            
            const message = {
                productId: productId,
                userName: userName,
                userEmail: userEmail,
                question: textInput.value.trim(),
                isReply: true,
                parentId: parentId
            };
            
            stompClient.send('/app/product/qa', {}, JSON.stringify(message));
            
            // Clear form
            if (!isAuthenticated) {
                const nameInput = document.getElementById('replyName' + parentId);
                const emailInput = document.getElementById('replyEmail' + parentId);
                if (nameInput) nameInput.value = '';
                if (emailInput) emailInput.value = '';
            }
            textInput.value = '';
            toggleReplyForm(parentId);
            
            showNotification('Câu trả lời đã được gửi!', 'success');
        }
        
        function loadReplies(questionId) {
            fetch('/api/products/qa/' + questionId + '/replies')
                .then(response => response.json())
                .then(replies => {
                    const repliesContainer = document.getElementById('replies' + questionId);
                    if (repliesContainer && replies.length > 0) {
                        repliesContainer.innerHTML = '';
                        replies.forEach(reply => {
                            displayReply(reply, questionId);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading replies:', error);
                });
        }
        
        function displayReply(reply, parentId) {
            console.log('displayReply called:', reply, 'parentId:', parentId);
            const repliesContainer = document.getElementById('replies' + parentId);
            if (!repliesContainer) {
                console.error('Replies container not found for parentId:', parentId);
                return;
            }
            
            // Check if reply already exists
            const existingReply = repliesContainer.querySelector(`[data-reply-id="${reply.id}"]`);
            if (existingReply) {
                console.log('Reply already exists, skipping');
                return;
            }
            
            const replyItem = document.createElement('div');
            replyItem.className = 'qa-reply-item';
            replyItem.setAttribute('data-reply-id', reply.id);
            
            const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(reply.userName)}&background=17a2b8&color=fff`;
            const timeAgo = reply.timestamp ? formatTimeAgo(reply.timestamp) : 'Vừa xong';
            
            replyItem.innerHTML = `
                <div class="d-flex align-items-start gap-2">
                    <img src="${avatarUrl}" class="qa-avatar-small" alt="${reply.userName}">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="qa-item-author">${reply.userName}</span>
                                <span class="qa-item-time">${timeAgo}</span>
                            </div>
                        </div>
                        <p class="qa-item-question mb-0">${reply.question}</p>
                    </div>
                </div>
            `;
            
            repliesContainer.appendChild(replyItem);
            console.log('Reply added to container');
        }
        
        function toggleLike(qaId) {
            const userIdentifier = getUserIdentifier();
            
            fetch(`/api/products/qa/${qaId}/like?userIdentifier=${userIdentifier}`)
                .then(response => response.json())
                .then(likesCount => {
                    // Update will come via WebSocket
                    console.log('Like toggled, new count:', likesCount);
                })
                .catch(error => {
                    console.error('Error toggling like:', error);
                    showNotification('Có lỗi xảy ra', 'error');
                });
        }
        
        function updateLikeCount(qaId, likesCount) {
            const qaItem = document.querySelector(`[data-qa-id="${qaId}"]`);
            if (qaItem) {
                const likeCountElement = qaItem.querySelector('.like-count');
                if (likeCountElement) {
                    likeCountElement.textContent = likesCount;
                }
            }
        }
        
        function getUserIdentifier() {
            let identifier = localStorage.getItem('userIdentifier');
            if (!identifier) {
                identifier = 'user_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
                localStorage.setItem('userIdentifier', identifier);
            }
            return identifier;
        }
        
        function formatTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);
            
            if (seconds < 60) return 'Vừa xong';
            if (seconds < 3600) return Math.floor(seconds / 60) + ' phút trước';
            if (seconds < 86400) return Math.floor(seconds / 3600) + ' giờ trước';
            if (seconds < 604800) return Math.floor(seconds / 86400) + ' ngày trước';
            return date.toLocaleDateString('vi-VN');
        }
        
        // Update avatar when name changes
        const nameInput = document.getElementById('userNameInput');
        if (nameInput) {
            nameInput.addEventListener('input', function() {
                updateAvatar(this.value);
            });
        }
        
        // Connect WebSocket on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedUserInfo();
            connectWebSocket();
        });
        
        // Add to cart function for main product
        document.addEventListener('DOMContentLoaded', function() {
            const addToCartBtn = document.querySelector('.btn-add-cart-modern');
            
            if (addToCartBtn) {
                addToCartBtn.addEventListener('click', function() {
                    const productId = this.getAttribute('data-product-id');
                    const productName = this.getAttribute('data-product-name');
                    const productPrice = parseFloat(this.getAttribute('data-product-price'));
                    const productImage = this.getAttribute('data-product-image');
                    const quantityInput = document.getElementById('quantity');
                    const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
                    
                    // Validate quantity
                    if (quantity < 1) {
                        showNotification('Số lượng phải lớn hơn 0', 'error');
                        return;
                    }
                    
                    // Show loading state
                    const originalContent = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-arrow-repeat spin me-2"></i>Đang thêm...';
                    this.disabled = true;
                    
                    // Wait for CartManager to be available
                    const tryAddToCart = () => {
                        if (typeof window.CartManager !== 'undefined') {
                            try {
                                window.CartManager.addToCart({
                                    productId: parseInt(productId),
                                    productName: productName,
                                    price: productPrice,
                                    quantity: quantity,
                                    imageUrl: productImage
                                });
                                
                                // Success state
                                this.innerHTML = '<i class="bi bi-check-circle me-2"></i>Đã thêm!';
                                this.classList.add('btn-success');
                                
                                // Show success notification
                                showNotification('Đã thêm sản phẩm vào giỏ hàng!', 'success');
                                
                                // Reset button after 2 seconds
                                setTimeout(() => {
                                    this.innerHTML = originalContent;
                                    this.classList.remove('btn-success');
                                    this.disabled = false;
                                }, 2000);
                            } catch (error) {
                                console.error('Error:', error);
                                this.innerHTML = originalContent;
                                this.disabled = false;
                                showNotification('Có lỗi xảy ra khi thêm sản phẩm', 'error');
                            }
                        } else {
                            // Retry after 100ms
                            setTimeout(tryAddToCart.bind(this), 100);
                        }
                    };
                    
                    tryAddToCart.call(this);
                });
            }
        });
        
        // Add to cart function for related products
        function addToCartFromRelated(button) {
            const productId = button.getAttribute('data-product-id');
            const productName = button.getAttribute('data-product-name');
            const productPrice = button.getAttribute('data-product-price');
            const productImage = button.getAttribute('data-product-image');
            
            // Show loading state
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="bi bi-arrow-repeat spin"></i>';
            button.disabled = true;
            
            // Call API to add to cart
            fetch('/cart/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    productId: parseInt(productId),
                    quantity: 1
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Success state
                    button.innerHTML = '<i class="bi bi-check"></i>';
                    button.classList.add('btn-success');
                    
                    // Show success notification
                    showNotification(data.message || 'Đã thêm sản phẩm vào giỏ hàng!', 'success');
                    
                    // Update cart badge if exists
                    updateCartBadge(data.cartItemCount);
                    
                    // Reset button after 2 seconds
                    setTimeout(() => {
                        button.innerHTML = originalContent;
                        button.classList.remove('btn-success');
                        button.disabled = false;
                    }, 2000);
                } else {
                    // Error state
                    button.innerHTML = originalContent;
                    button.disabled = false;
                    showNotification(data.message || 'Có lỗi xảy ra khi thêm sản phẩm', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                button.innerHTML = originalContent;
                button.disabled = false;
                showNotification('Có lỗi xảy ra khi thêm sản phẩm', 'error');
            });
        }
        
        // Notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="bi bi-${getNotificationIcon(type)} me-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Show notification
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            // Hide and remove notification
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        function getNotificationIcon(type) {
            switch(type) {
                case 'success': return 'check-circle-fill';
                case 'error': return 'exclamation-triangle-fill';
                case 'warning': return 'exclamation-triangle-fill';
                default: return 'info-circle-fill';
            }
        }
        
        // Update cart badge
        function updateCartBadge(count) {
            const cartBadges = document.querySelectorAll('.cart-badge, .badge');
            cartBadges.forEach(badge => {
                if (badge.closest('.cart-icon') || badge.closest('[href*="cart"]')) {
                    badge.textContent = count;
                    if (count > 0) {
                        badge.style.display = 'inline-block';
                    }
                }
            });
        }
    </script>
    
    <!-- Notification Styles -->
    <style>
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .notification-error {
            background: linear-gradient(135deg, #dc3545, #e74c3c);
        }
        
        .notification-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }
        
        .notification-info {
            background: linear-gradient(135deg, #17a2b8, #007bff);
        }
        
        .notification-content {
            display: flex;
            align-items: center;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            border-color: #28a745 !important;
        }
        
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
    
    <!-- Related Products Auto Slider Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('relatedProductsSlider');
            if (!slider) return;
            
            const items = Array.from(slider.querySelectorAll('.related-product-item'));
            if (items.length === 0 || items.length <= 4) return; // No need to slide if 4 or fewer items
            
            // Clone items for infinite loop
            items.forEach(item => {
                const clone = item.cloneNode(true);
                // Re-attach event listeners to cloned buttons
                const clonedButton = clone.querySelector('.add-to-cart-btn');
                if (clonedButton) {
                    clonedButton.onclick = function() {
                        addToCartFromRelated(this);
                    };
                }
                slider.appendChild(clone);
            });
            
            let scrollPosition = 0;
            let isHovered = false;
            let animationId = null;
            
            function autoSlide() {
                if (!isHovered) {
                    scrollPosition += 0.5; // Scroll speed
                    
                    // Reset position for infinite loop
                    const firstItem = items[0];
                    if (!firstItem) return;
                    
                    const itemWidth = firstItem.offsetWidth;
                    const gap = 16; // 1rem gap
                    const totalWidth = (itemWidth + gap) * items.length;
                    
                    if (scrollPosition >= totalWidth) {
                        scrollPosition = 0;
                    }
                    
                    slider.style.transform = `translateX(-${scrollPosition}px)`;
                }
                
                animationId = requestAnimationFrame(autoSlide);
            }
            
            // Start auto slide
            autoSlide();
            
            // Pause on hover
            slider.addEventListener('mouseenter', function() {
                isHovered = true;
            });
            
            // Resume on mouse leave
            slider.addEventListener('mouseleave', function() {
                isHovered = false;
            });
            
            // Clean up on page unload
            window.addEventListener('beforeunload', function() {
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
            });
        });
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Cart Scripts - Load in correct order -->
    <script th:src="@{/js/cart-manager.js(v=1)}"></script>
    <script th:src="@{/js/cart-sync.js(v=1)}"></script>
    <script th:src="@{/js/cart-animations-v2.js(v=1)}"></script>
    <script th:src="@{/js/header.js(v=1)}"></script>
    
    <!-- Footer -->
    <div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>